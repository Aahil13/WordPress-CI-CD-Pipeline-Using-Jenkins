version: v1.0
name: Setup WordPress with MySQL using Docker Secrets
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Install Dependencies
    task:
      prologue:
        commands:
          - echo "Installing dependencies..."
      jobs:
        - name: Install Docker
          commands:
            - sudo apt-get update
            - sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
            - 'curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -'
            - 'sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"'
            - sudo apt-get update
            - sudo apt-get install -y docker-ce
            - 'sudo chown $USER:$USER /var/run/docker.sock'
    dependencies: []
  - name: Generate Docker Secrets
    task:
      prologue:
        commands:
          - echo "Generating Docker secrets..."
          - docker swarm init
      jobs:
        - name: Create MySQL Root Password Secret
          commands:
            - openssl rand -base64 20 | docker secret create mysql_root_password -
        - name: Create WordPress Database Password Secret
          commands:
            - openssl rand -base64 20 | docker secret create mysql_password -
    dependencies:
      - Install Dependencies
  - name: Create MySQL Service
    task:
      prologue:
        commands:
          - echo "Creating MySQL service..."
          - docker swarm init
      jobs:
        - name: Setup MySQL Service
          commands:
            - docker network create -d overlay mysql_private
            - |
              docker service create \
                --name mysql \
                --replicas 1 \
                --network mysql_private \
                --mount type=volume,source=mydata,destination=/var/lib/mysql \
                --secret source=mysql_root_password,target=mysql_root_password \
                --secret source=mysql_password,target=mysql_password \
                -e MYSQL_ROOT_PASSWORD_FILE="/run/secrets/mysql_root_password" \
                -e MYSQL_PASSWORD_FILE="/run/secrets/mysql_password" \
                -e MYSQL_USER="wordpress" \
                -e MYSQL_DATABASE="wordpress" \
                mysql:latest
    dependencies:
      - Generate Docker Secrets
  - name: Create WordPress Service
    task:
      prologue:
        commands:
          - echo "Creating WordPress service..."
      jobs:
        - name: Setup WordPress Service
          commands:
            - 'docker service create \ --name wordpress \ --replicas 1 \ --network mysql_private \ --publish published=30000,target=80 \ --mount type=volume,source=wpdata,destination=/var/www/html \ --secret source=mysql_password,target=wp_db_password \ -e WORDPRESS_DB_USER="wordpress" \ -e WORDPRESS_DB_PASSWORD_FILE="/run/secrets/wp_db_password" \ -e WORDPRESS_DB_HOST="mysql:3306" \ -e WORDPRESS_DB_NAME="wordpress" \ wordpress:latest'
    dependencies:
      - Create MySQL Service
  - name: Verify and Test
    task:
      prologue:
        commands:
          - echo "Verifying services..."
      jobs:
        - name: Verify Services
          commands:
            - docker service ls
            - docker service ps wordpress
    dependencies:
      - Create WordPress Service
